<!DOCTYPE html >
<html>
<head>
<meta charset="utf-8">
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<script type="text/javascript" src="js/vue.min.js"></script>
<script src="http://cdn.bootcss.com/sockjs-client/1.0.3/sockjs.min.js"></script>
<title>Insert title here</title>
<style type="text/css">
#connect-container {
	float: left;
	width: 400px
}

#connect-container div {
	padding: 5px;
}

#console-container {
	float: left;
	margin-left: 15px;
	width: 400px;
}

#console {
	border: 1px solid #CCCCCC;
	border-right-color: #999999;
	border-bottom-color: #999999;
	height: 170px;
	overflow-y: scroll;
	padding: 5px;
	width: 100%;
}

#console p {
	padding: 0;
	margin: 0;
}

.video-x {
	position: relative;
	width: 640px;
	margin: auto;
}

.video-x video {
	background-color: black;
	outline: 1px solid #eee;
}

.canvas-barrage {
	position: absolute;
	width: 640px;
	height: 360px;
	pointer-events: none;
	z-index: 1;
}

input[type="range"] {
	vertical-align: middle;
	margin-right: 50px;
}

.ui-radio+label {
	margin-left: 5px;
	margin-right: 20px;
}

input[type="submit"] {
	margin-left: 10px;
	margin-right: 50px;
}

[disabled] {
	pointer-events: none;
	opacity: .4;
}

.last {
	border-top: 1px solid #eee;
	margin-top: 1.5em;
	padding-top: 2em;
}
</style>
<body>

	<div>
		<div id="connect-container">
			<input id="radio1" type="radio" name="group1"
				onclick="updateUrl('/Wechat/ws/chat/system/system');"> <label
				for="radio1">W3C WebSocket</label> <br>
			<div id="sockJsTransportSelect" style="visibility: hidden;">
				<span>SockJS transport:</span> <select
					onchange="updateTransport(this.value)">
					<option value="all">all</option>
					<option value="websocket">websocket</option>
					<option value="xhr-polling">xhr-polling</option>
					<option value="jsonp-polling">jsonp-polling</option>
					<option value="xhr-streaming">xhr-streaming</option>
					<option value="iframe-eventsource">iframe-eventsource</option>
					<option value="iframe-htmlfile">iframe-htmlfile</option>
				</select>
			</div>
			<div>
				<button id="connect" onclick="connect();">Connect</button>
				<button id="disconnect" disabled="disabled" onclick="disconnect();">Disconnect</button>
			</div>
			<div>
				<textarea id="message" style="width: 350px">Here is a message!</textarea>
			</div>
			<div>
				<button id="echo" onclick="echo();" disabled="disabled">Echo
					message</button>
			</div>
		</div>
		<div id="console-container">
			<div id="console"></div>
		</div>

	</div>

	<div class="video-x">
		<canvas id="canvasBarrage" class="canvas-barrage"></canvas>
		<video id="videoBarrage" width="640" height="384"
			src="http://www.zhangxinxu.com/study/201709/video.mp4" controls></video>
		<form id="barrageForm" action="barrage.php" method="post"
			autocomplete="off">
			<p>
				透明度(0-100)：<input type="range" class="range" name="opacity"
					value="100" min="0" max="100"> 文字大小(16-32)：<input
					type="range" class="range" name="fontSize" value="24" min="16"
					max="32">
			</p>
			<p>
				弹幕位置：<input type="radio" id="rangeFull" name="range" checked
					value="0,1"><label class="ui-radio" for="rangeFull"></label><label
					for="rangeFull">全部位置</label> <input type="radio" id="rangeTop"
					name="range" value="0,0.3"><label class="ui-radio"
					for="rangeTop"></label><label for="rangeTop">顶部</label> <input
					type="radio" id="rangeBottom" name="range" value="0.7,1"><label
					class="ui-radio" for="rangeBottom"></label><label for="rangeBottom">底部</label>
			</p>
			<p class="last">
				<input class="ui-input" id="input" name="value" required><input
					type="submit" class="ui-button ui-button-primary" value="发送弹幕"
					disabled> 颜色：<input type="color" id="color" name="color"
					value="#ff0000">
			</p>
		</form>
	</div>

</body>

<script src="js/canvasBarrage.js"></script>
	<script>
// 弹幕数据
var dataBarrage = [];

// 初始化弹幕方法
var eleCanvas = document.getElementById('canvasBarrage');
var eleVideo = document.getElementById('videoBarrage');

var demoBarrage = new CanvasBarrage(eleCanvas, eleVideo, {
	data: dataBarrage
});

// 下面是交互处理，与弹幕方法本身无关，旨在演示如何修改全局设置，新增弹幕等
// 1. 全局的弹幕大小，位置和透明度处理
document.addEventListener("DOMContentLoaded", function() {
	$('.range').on('change', function () {
		// 改变弹幕的透明度和字号大小
		demoBarrage[this.name] = this.value * 1;
	});
	
	$('input[name="range"]').on('click', function () {
		// 改变弹幕在视频显示的区域范围
		demoBarrage['range'] = this.value.split(',');
	});
	
	// 发送弹幕
	var elForm = $('#barrageForm'), elInput = $('#input');
	elForm.on('submit', function (event) {
		event.preventDefault();	
		// 新增弹幕
		demoBarrage.add({
			value: $('#input').val(),
			color: $('#color').val(),
			time: eleVideo.currentTime
		});
		
		elInput.val('').trigger('input');
	});
	// 提交按钮
	var elSubmit = elForm.find('input[type="submit"]');
	
	// 输入框和禁用按钮
	elInput.on('input', function () {
		if (this.value.trim()) {
			elSubmit.removeAttr('disabled');
		} else {
			elSubmit.attr('disabled', 'disabled');
		}
	});
	
}, false);
</script>
<script
		src="https://qidian.gtimg.com/c/=/lulu/theme/peak/js/plugin/jquery.js,/lulu/theme/peak/js/common/ui/Follow.js,/lulu/theme/peak/js/common/ui/Tips.js,/lulu/theme/peak/js/common/ui/Range.js,/lulu/theme/peak/js/common/ui/Drop.js,/lulu/theme/peak/js/common/ui/Color.js"></script>
	<script>
$('.range').range();
$('#color').color();
</script>
<script type="text/javascript">
var ws = null;  
var url =null;  
var transports = [];  

function setConnected(connected) {  
    document.getElementById('connect').disabled = connected;  
    document.getElementById('disconnect').disabled = !connected;  
    document.getElementById('echo').disabled = !connected;  
}  

function connect() {  
    //alert("url:"+url);  
    if (!url) {  
        alert('Select whether to use W3C WebSocket or SockJS');  
        return;  
    }  

    ws = (url.indexOf('sockjs') != -1) ?   
        new SockJS(url, undefined, {protocols_whitelist: transports}) : new WebSocket(url);  

    ws.onopen = function () {  
        setConnected(true);  
        log('Info: connection opened.');  
    };  
    ws.onmessage = function (event) {  
        log('Received: ' + event.data); 
        alert(typeof demoBarrage)
        demoBarrage.push({
			value: event.data,
			color: 'yellow',
			time: eleVideo.currentTime
		});
       
        
    };  
    ws.onclose = function (event) {  
        setConnected(false);  
        log('Info: connection closed.');  
        log(event);  
    };  
}  

function disconnect() {  
    if (ws != null) {  
        ws.close();  
        ws = null;  
    }  
    setConnected(false);  
}  

function echo() {  
    if (ws != null) {  
        var message = document.getElementById('message').value;  
        log('Sent: ' + message);  
        ws.send(message);  
    } else {  
        alert('connection not established, please connect.');  
    }  
}  

function updateUrl(urlPath) {  
    if (urlPath.indexOf('sockjs') != -1) {  
        url = urlPath;  
        document.getElementById('sockJsTransportSelect').style.visibility = 'visible';  
    }  
    else {  
    
      if (window.location.protocol == 'http:') {  
          url = 'ws://' + window.location.host + urlPath;  
      } else {  
          url = 'wss://' + window.location.host + urlPath;  
      }  
      document.getElementById('sockJsTransportSelect').style.visibility = 'hidden';  
    }  
}  

function updateTransport(transport) {  
    alert(transport);  
  transports = (transport == 'all') ?  [] : [transport];  
}  
  
function log(message) {  
    var console = document.getElementById('console');  
    var p = document.createElement('p');  
    p.style.wordWrap = 'break-word';  
    p.appendChild(document.createTextNode(message));  
    console.appendChild(p);  
    while (console.childNodes.length > 25) {  
        console.removeChild(console.firstChild);  
    }  
    console.scrollTop = console.scrollHeight;  
}  
 </script>
</html>